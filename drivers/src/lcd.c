#include "lcd.h"
#include "main.h"
uint8_t current_page = 0;    // Range: 0 to 7 (each page = 8 vertical pixels)
uint8_t current_column = 0;  // Range: 0 to 127 (screen width)


void LCD_Select() {
    GPIO_WriteToOutputPin(GPIOB, GPIO_PIN_NO_12, GPIO_PIN_RESET);  // Active low
}

void LCD_Unselect() {
    GPIO_WriteToOutputPin(GPIOB, GPIO_PIN_NO_12, GPIO_PIN_SET);
}

void lcd_reset(void)
{
  GPIO_WriteToOutputPin(GPIOA, GPIO_PIN_NO_8, GPIO_PIN_RESET); // RST low
  delay();
  GPIO_WriteToOutputPin(GPIOA, GPIO_PIN_NO_8, GPIO_PIN_SET);   // RST high
  delay();
}

void lcd_send_command(uint8_t cmd) {
    LCD_Select();
    GPIO_WriteToOutputPin(GPIOA, GPIO_PIN_NO_9, GPIO_PIN_RESET);  // RS = 0 for command
    SPI_SendData(SPI1, &cmd, 1);
    while (SPI_GetFlagStatus(SPI1, SPI_FLAG_BUSY));
    LCD_Unselect();
}

void lcd_send_data(uint8_t data) {
    LCD_Select();
    GPIO_WriteToOutputPin(GPIOA, GPIO_PIN_NO_9, GPIO_PIN_SET);  // RS = 1 for data
    SPI_SendData(SPI1, &data, 1);
    while (SPI_GetFlagStatus(SPI1, SPI_FLAG_BUSY));
    LCD_Unselect();
}

#if 0
void lcd_init() {
    GPIO_WriteToOutputPin(GPIOA, GPIO_PIN_NO_8, GPIO_PIN_RESET);
    delay();
    GPIO_WriteToOutputPin(GPIOA, GPIO_PIN_NO_8, GPIO_PIN_SET);
    delay();

    lcd_send_command(0xE2); // Software reset
    lcd_send_command(0xA3); // Bias 1/9
    lcd_send_command(0xA0); // ADC normal
    lcd_send_command(0xC8); // Common output: reverse
    lcd_send_command(0x2F); // Power control: Booster, Regulator, Follower
    lcd_send_command(0x4f); //Dynamic contrast
    lcd_send_command(0x81);
    lcd_send_command(0x25);
    lcd_send_command(0x40);
    lcd_send_command(0xAF); // Display ON
}
#else
void lcd_init() {
    GPIO_WriteToOutputPin(GPIOA, GPIO_PIN_NO_8, GPIO_PIN_RESET);
    delay();
    GPIO_WriteToOutputPin(GPIOA, GPIO_PIN_NO_8, GPIO_PIN_SET);
    delay();
    lcd_send_command(0xE2); // Software reset
    lcd_send_command(0xA3); // Bias 1/9
    lcd_send_command(0xA0); // ADC normal
    lcd_send_command(0xC8); // Common output: reverse
    lcd_send_command(0x2F); // Power control: Booster, Regulator, Follower
    lcd_send_command(0x4f); //Dynamic contrast
    lcd_send_command(0x30);
    lcd_send_command(0x40);
    lcd_send_command(0xAF); // Display ON


}
#endif


void lcd_set_page(uint8_t page)
{
  lcd_send_command(0xB0 | (page & 0x0F));
}

void lcd_set_column(uint8_t column)
{
  lcd_send_command(0x10 | (column >> 4));      // MSB
  lcd_send_command(0x00 | (column & 0x0F));    // LSB
}

void lcd_write_char(char c)
{
  if (c < 32 || c > 126) c = ' '; // sanitize
  const uint8_t *char_data = font5x8[c - 32];
  for (int i = 0; i < 5; i++) {
    lcd_send_data(char_data[i]);
  }
  lcd_send_data(0x00); // space between chars
}

void lcd_write_string(const char *str)
{
    while (*str)
    {
        lcd_write_char(*str);
        str++;
    }
}


void lcd_set_black_background(void)
{
  for (int page = 0; page < 8; page++) {
      lcd_set_page(page);
      lcd_set_column(0);
      for (int col = 0; col < 128; col++) {
          lcd_send_data(0x00);  // black background
      }
  }
}

void lcd_set_cursor(uint8_t page, uint8_t column) {
    current_page = page;
    current_column = column;
}


void lcd_write_string_big(const char *str)
{
    while (*str != '\0')
    {
        lcd_write_char_big(*str);
        str++;
    }
}

const uint8_t font5x8[][5] = {
  // ASCII 32–47
  {0x00,0x00,0x00,0x00,0x00}, // ' '
  {0x00,0x00,0x5F,0x00,0x00}, // '!'
  {0x00,0x07,0x00,0x07,0x00}, // '"'
  {0x14,0x7F,0x14,0x7F,0x14}, // '#'
  {0x24,0x2A,0x7F,0x2A,0x12}, // '$'
  {0x23,0x13,0x08,0x64,0x62}, // '%'
  {0x36,0x49,0x55,0x22,0x50}, // '&'
  {0x00,0x05,0x03,0x00,0x00}, // '''
  {0x00,0x1C,0x22,0x41,0x00}, // '('
  {0x00,0x41,0x22,0x1C,0x00}, // ')'
  {0x14,0x08,0x3E,0x08,0x14}, // '*'
  {0x08,0x08,0x3E,0x08,0x08}, // '+'
  {0x00,0x50,0x30,0x00,0x00}, // ','
  {0x08,0x08,0x08,0x08,0x08}, // '-'
  {0x00,0x60,0x60,0x00,0x00}, // '.'
  {0x20,0x10,0x08,0x04,0x02}, // '/'

  // ASCII 48–63
  {0x3E,0x51,0x49,0x45,0x3E}, // '0'
  {0x00,0x42,0x7F,0x40,0x00}, // '1'
  {0x42,0x61,0x51,0x49,0x46}, // '2'
  {0x21,0x41,0x45,0x4B,0x31}, // '3'
  {0x18,0x14,0x12,0x7F,0x10}, // '4'
  {0x27,0x45,0x45,0x45,0x39}, // '5'
  {0x3C,0x4A,0x49,0x49,0x30}, // '6'
  {0x01,0x71,0x09,0x05,0x03}, // '7'
  {0x36,0x49,0x49,0x49,0x36}, // '8'
  {0x06,0x49,0x49,0x29,0x1E}, // '9'
  {0x00,0x36,0x36,0x00,0x00}, // ':'
  {0x00,0x56,0x36,0x00,0x00}, // ';'
  {0x08,0x14,0x22,0x41,0x00}, // '<'
  {0x14,0x14,0x14,0x14,0x14}, // '='
  {0x00,0x41,0x22,0x14,0x08}, // '>'
  {0x02,0x01,0x51,0x09,0x06}, // '?'

  // ASCII 64–79
  {0x32,0x49,0x79,0x41,0x3E}, // '@'
  {0x7E,0x11,0x11,0x11,0x7E}, // 'A'
  {0x7F,0x49,0x49,0x49,0x36}, // 'B'
  {0x3E,0x41,0x41,0x41,0x22}, // 'C'
  {0x7F,0x41,0x41,0x22,0x1C}, // 'D'
  {0x7F,0x49,0x49,0x49,0x41}, // 'E'
  {0x7F,0x09,0x09,0x09,0x01}, // 'F'
  {0x3E,0x41,0x49,0x49,0x7A}, // 'G'
  {0x7F,0x08,0x08,0x08,0x7F}, // 'H'
  {0x00,0x41,0x7F,0x41,0x00}, // 'I'
  {0x20,0x40,0x41,0x3F,0x01}, // 'J'
  {0x7F,0x08,0x14,0x22,0x41}, // 'K'
  {0x7F,0x40,0x40,0x40,0x40}, // 'L'
  {0x7F,0x02,0x0C,0x02,0x7F}, // 'M'
  {0x7F,0x04,0x08,0x10,0x7F}, // 'N'
  {0x3E,0x41,0x41,0x41,0x3E}, // 'O'

  // ASCII 80–95
  {0x7F,0x09,0x09,0x09,0x06}, // 'P'
  {0x3E,0x41,0x51,0x21,0x5E}, // 'Q'
  {0x7F,0x09,0x19,0x29,0x46}, // 'R'
  {0x46,0x49,0x49,0x49,0x31}, // 'S'
  {0x01,0x01,0x7F,0x01,0x01}, // 'T'
  {0x3F,0x40,0x40,0x40,0x3F}, // 'U'
  {0x1F,0x20,0x40,0x20,0x1F}, // 'V'
  {0x7F,0x20,0x18,0x20,0x7F}, // 'W'
  {0x63,0x14,0x08,0x14,0x63}, // 'X'
  {0x03,0x04,0x78,0x04,0x03}, // 'Y'
  {0x61,0x51,0x49,0x45,0x43}, // 'Z'
  {0x00,0x7F,0x41,0x41,0x00}, // '['
  {0x02,0x04,0x08,0x10,0x20}, // '\'
  {0x00,0x41,0x41,0x7F,0x00}, // ']'
  {0x04,0x02,0x01,0x02,0x04}, // '^'
  {0x40,0x40,0x40,0x40,0x40}, // '_'

  // ASCII 96–111
  {0x00,0x01,0x02,0x04,0x00}, // '`'
  {0x20,0x54,0x54,0x54,0x78}, // 'a'
  {0x7F,0x48,0x44,0x44,0x38}, // 'b'
  {0x38,0x44,0x44,0x44,0x20}, // 'c'
  {0x38,0x44,0x44,0x48,0x7F}, // 'd'
  {0x38,0x54,0x54,0x54,0x18}, // 'e'
  {0x08,0x7E,0x09,0x01,0x02}, // 'f'
  {0x0C,0x52,0x52,0x52,0x3E}, // 'g'
  {0x7F,0x08,0x04,0x04,0x78}, // 'h'
  {0x00,0x44,0x7D,0x40,0x00}, // 'i'
  {0x20,0x40,0x44,0x3D,0x00}, // 'j'
  {0x7F,0x10,0x28,0x44,0x00}, // 'k'
  {0x00,0x41,0x7F,0x40,0x00}, // 'l'
  {0x7C,0x04,0x18,0x04,0x78}, // 'm'
  {0x7C,0x08,0x04,0x04,0x78}, // 'n'
  {0x38,0x44,0x44,0x44,0x38}, // 'o'

  // ASCII 112–127
  {0x7C,0x14,0x14,0x14,0x08}, // 'p'
  {0x08,0x14,0x14,0x18,0x7C}, // 'q'
  {0x7C,0x08,0x04,0x04,0x08}, // 'r'
  {0x48,0x54,0x54,0x54,0x20}, // 's'
  {0x04,0x3F,0x44,0x40,0x20}, // 't'
  {0x3C,0x40,0x40,0x20,0x7C}, // 'u'
  {0x1C,0x20,0x40,0x20,0x1C}, // 'v'
  {0x3C,0x40,0x30,0x40,0x3C}, // 'w'
  {0x44,0x28,0x10,0x28,0x44}, // 'x'
  {0x0C,0x50,0x50,0x50,0x3C}, // 'y'
  {0x44,0x64,0x54,0x4C,0x44}, // 'z'
  {0x00,0x08,0x36,0x41,0x00}, // '{'
  {0x00,0x00,0x7F,0x00,0x00}, // '|'
  {0x00,0x41,0x36,0x08,0x00}, // '}'
  {0x10,0x08,0x08,0x10,0x08}, // '~'
};

const uint8_t big_digits[][24] =
{
/* '0' */
{
  0xF0,0xFC,0x0E,0x06,0x06,0x06,0x06,0x0E,0xFC,0xF0,0x00,0x00,
  0x0F,0x3F,0x70,0x60,0x60,0x60,0x60,0x70,0x3F,0x0F,0x00,0x00
},

/* '1' */
{
  0x00,0x18,0x18,0x0C,0xFE,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x60,0x60,0x60,0x7F,0x7F,0x60,0x60,0x60,0x00,0x00,0x00
},

/* '2' */
{
  0x18,0x1C,0x0E,0x06,0x06,0x86,0xC6,0xCE,0xBC,0x18,0x00,0x00,
  0x70,0x78,0x6C,0x66,0x63,0x61,0x60,0x60,0x60,0x60,0x00,0x00
},

/* '3' */
{
  0x1C,0x1E,0x06,0x06,0x46,0x46,0xEE,0xBC,0x18,0x00,0x00,0x00,
  0x38,0x78,0x60,0x60,0x62,0x62,0x77,0x3D,0x18,0x00,0x00,0x00
},

/* '4' */
{
  0x00,0x80,0xC0,0xE0,0x70,0x38,0x1C,0xFE,0xFE,0x00,0x00,0x00,
  0x0C,0x0E,0x0F,0x0D,0x0C,0x0C,0x0C,0x7F,0x7F,0x0C,0x00,0x00
},

/* '5' */
{
  0x7E,0x7E,0x46,0x46,0x46,0x46,0xC6,0x86,0x02,0x00,0x00,0x00,
  0x30,0x78,0x60,0x60,0x60,0x60,0x71,0x3B,0x1E,0x00,0x00,0x00
},

/* '6' */
{
  0xF0,0xF8,0x4C,0x46,0x46,0x46,0xCE,0xCC,0x80,0x00,0x00,0x00,
  0x1F,0x3F,0x73,0x61,0x61,0x61,0x73,0x3F,0x1E,0x00,0x00,0x00
},

/* '7' */
{
  0x06,0x06,0x06,0x06,0x86,0xC6,0x66,0x36,0x1E,0x00,0x00,0x00,
  0x00,0x00,0x7C,0x7E,0x07,0x03,0x01,0x00,0x00,0x00,0x00,0x00
},

/* '8' */
{
  0x38,0x7C,0xCE,0xC6,0xC6,0xC6,0xC6,0xCE,0x7C,0x38,0x00,0x00,
  0x1C,0x3E,0x73,0x61,0x61,0x61,0x61,0x73,0x3E,0x1C,0x00,0x00
},

/* '9' */
{
  0x38,0x7C,0xCE,0xC6,0xC6,0xC6,0xCE,0x7C,0x38,0x00,0x00,0x00,
  0x01,0x33,0x63,0x63,0x63,0x63,0x73,0x3F,0x1F,0x00,0x00,0x00
},

/* '.' */
{
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xC0,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x03,0x00,0x00,0x00
},

/* '°' */
{
  0x1C,0x3E,0x22,0x22,0x3E,0x1C,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
},

/* 'C' */
{
  0xF8,0xFC,0x0E,0x06,0x06,0x06,0x06,0x0E,0x1C,0x00,0x00,0x00,
  0x1F,0x3F,0x70,0x60,0x60,0x60,0x70,0x38,0x1C,0x00,0x00,0x00
}
};

void lcd_write_char_large(char c)
{
    uint8_t index;

    if (c >= '0' && c <= '9')
        index = c - '0';
    else if (c == '.')
        index = 10;
    else if (c == '°')
        index = 11;
    else if (c == 'C')
        index = 12;
    else
        return;

    const uint8_t *glyph = big_digits[index];

    /* Top page (8 rows) */
    lcd_set_page(current_page);
    lcd_set_column(current_column);

    for (int i = 0; i < 12; i++)
        lcd_send_data(glyph[i]);

    /* Bottom page (8 rows) */
    lcd_set_page(current_page + 1);
    lcd_set_column(current_column);

    for (int i = 12; i < 24; i++)
        lcd_send_data(glyph[i]);

    current_column += 13;
}


void lcd_write_char_big(char c) {
    if (c < 32 || c > 126) c = ' ';  // sanitize
    const uint8_t *char_data = font5x8[c - 32];

    // Top half (page)
    lcd_set_page(current_page);
    lcd_set_column(current_column);
    for (int i = 0; i < 5; i++) {
        uint8_t col = char_data[i];
        uint8_t top_byte = 0;
        for (int b = 0; b < 8; b++) {
            if (col & (1 << b)) {
                top_byte |= (3 << (b * 2));  // duplicate vertically
            }
        }
        // Write each column twice for 2x width
        lcd_send_data(top_byte);
        lcd_send_data(top_byte);
    }
    // spacing
    lcd_send_data(0x00);
    lcd_send_data(0x00);

    // Bottom half (next page)
    lcd_set_page(current_page + 1);
    lcd_set_column(current_column);
    for (int i = 0; i < 5; i++) {
        uint8_t col = char_data[i];
        uint8_t bottom_byte = 0;
        for (int b = 0; b < 8; b++) {
            if (col & (1 << b)) {
                bottom_byte |= (3 << ((b * 2) - 8));  // shift to lower byte for bottom
            }
        }
        // Write each column twice for 2x width
        lcd_send_data(bottom_byte);
        lcd_send_data(bottom_byte);
    }
    // spacing
    lcd_send_data(0x00);
    lcd_send_data(0x00);

    // advance cursor
    current_column += 12;
}

void delay(void)
{
  for (uint32_t i = 0; i<25000; i++);
}
